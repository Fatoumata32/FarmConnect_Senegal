{% load static %}
<!-- Section: Liste des Cultures avec Carousel et Recherche Intelligente -->
<section class="py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="display-5 fw-bold" style="color: #2d5016;">
                <i class="fas fa-seedling"></i> Cultures du S√©n√©gal
            </h2>
            <p class="lead text-muted">
                D√©couvrez plus de 50 cultures adapt√©es au climat s√©n√©galais.<br>
                Utilisez la recherche intelligente ou parcourez le carousel.
            </p>
        </div>

        <!-- Barre de recherche intelligente -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="search-container position-relative">
                    <div class="input-group input-group-lg shadow">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-success"></i>
                        </span>
                        <input
                            type="text"
                            id="cropSearch"
                            class="form-control border-start-0 ps-0"
                            placeholder="Rechercher une culture (ex: arachide, tomate, mil...)"
                            autocomplete="off"
                        >
                        <button class="btn btn-outline-secondary" id="clearSearch" type="button" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- R√©sultats de recherche (dropdown) -->
                    <div id="searchResults" class="search-results position-absolute w-100 mt-1 bg-white rounded shadow-lg" style="display: none; max-height: 400px; overflow-y: auto; z-index: 1000;">
                        <!-- Les r√©sultats seront affich√©s ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres par cat√©gorie -->
        <div class="mb-4 text-center">
            <div class="btn-group flex-wrap" role="group">
                <button type="button" class="btn btn-outline-success active category-filter" data-filter="all">
                    <i class="fas fa-th"></i> Toutes
                </button>
                <button type="button" class="btn btn-outline-success category-filter" data-filter="cereales">
                    <i class="fas fa-wheat"></i> C√©r√©ales
                </button>
                <button type="button" class="btn btn-outline-success category-filter" data-filter="legumes">
                    <i class="fas fa-carrot"></i> L√©gumes
                </button>
                <button type="button" class="btn btn-outline-success category-filter" data-filter="fruits">
                    <i class="fas fa-apple-alt"></i> Fruits
                </button>
                <button type="button" class="btn btn-outline-success category-filter" data-filter="legumineuses">
                    <i class="fas fa-leaf"></i> L√©gumineuses
                </button>
                <button type="button" class="btn btn-outline-success category-filter" data-filter="tubercules">
                    <i class="fas fa-seedling"></i> Tubercules
                </button>
            </div>
        </div>

        <!-- Carousel de cultures avec Swiper -->
        <div class="position-relative">
            <div class="swiper cropsSwiper">
                <div class="swiper-wrapper" id="cropsCarousel">
                    <!-- Les slides seront charg√©s dynamiquement ici -->
                    <div class="swiper-slide">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-3 text-muted">Chargement des cultures...</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>

                <!-- Pagination -->
                <div class="swiper-pagination"></div>
            </div>
        </div>

        <!-- Compteur de r√©sultats -->
        <div class="text-center mt-4">
            <p class="text-muted">
                <span id="cropCount">0</span> culture(s) affich√©e(s)
                <span id="filterInfo"></span>
            </p>
        </div>
    </div>
</section>

<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<style>
    /* Styles g√©n√©raux */
    .crop-card {
        height: 100%;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        min-width: 250px; /* Assure une largeur minimale */
    }

    .crop-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(45, 80, 22, 0.2) !important;
        border-color: #2d5016;
    }

    .crop-card-image {
        height: 200px;
        object-fit: cover;
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    }

    .crop-card-icon {
        font-size: 4rem;
        color: #4a7c59;
    }

    .crop-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .btn-outline-success.active,
    .category-filter.active {
        background-color: #2d5016;
        color: white;
    }

    /* Styles du Carousel Swiper */
    .cropsSwiper {
        width: 100%;
        padding: 20px 50px 60px;
    }

    .swiper-slide {
        display: flex;
        justify-content: center;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: #2d5016;
        background: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 20px;
    }

    .swiper-pagination-bullet {
        background: #4a7c59;
        opacity: 0.5;
    }

    .swiper-pagination-bullet-active {
        background: #2d5016;
        opacity: 1;
    }

    /* Styles de la recherche */
    .search-container .form-control:focus {
        border-color: #2d5016;
        box-shadow: 0 0 0 0.2rem rgba(45, 80, 22, 0.25);
    }

    .search-results {
        border: 1px solid #dee2e6;
    }

    .search-result-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s ease;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-highlight {
        background: #fff3cd;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }

    .search-suggestion {
        font-size: 0.85rem;
        border-radius: 20px;
        margin-bottom: 5px;
    }

    .search-suggestion:hover {
        background: #2d5016;
        color: white;
        border-color: #2d5016;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .cropsSwiper {
            padding: 20px 10px 50px;
        }
    }
</style>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
/**
 * Variables globales
 */
let allCrops = [];
let filteredCrops = [];
let swiper = null;
const CROPS_PER_SLIDE = 4;

/**
 * Initialisation au chargement de la page
 */
document.addEventListener('DOMContentLoaded', async function() {
    await loadCrops();
    setupSearch();
    setupFilters();
});

/**
 * Charge les cultures depuis l'API ou le cache
 */
async function loadCrops() {
    try {
        let crops = [];

        // Charger depuis l'API REST
        try {
            console.log('[Carousel] Chargement des cultures depuis l\'API...');
            const response = await fetch('/api/crops/');

            if (response.ok) {
                const data = await response.json();
                crops = data.results || data;
                console.log(`[Carousel] ${crops.length} cultures charg√©es depuis l'API`);
            }
        } catch (apiError) {
            console.warn('[Carousel] API non disponible, tentative cache local...', apiError);

            // Essayer le cache local
            if (window.farmConnectDB) {
                crops = await window.farmConnectDB.getAllCrops();
                console.log(`[Carousel] ${crops.length} cultures charg√©es depuis le cache`);
            }
        }

        if (crops.length === 0) {
            showError('Aucune culture disponible', 'Les cultures seront charg√©es lors de votre prochaine connexion.');
            return;
        }

        allCrops = crops;
        filteredCrops = crops;
        displayCarousel(crops);
        updateCropCount(crops.length);

    } catch (error) {
        console.error('[Carousel] Erreur chargement cultures:', error);
        showError('Erreur de chargement', error.message || 'Impossible de charger les cultures');
    }
}

/**
 * Affiche les cultures dans le carousel
 */
function displayCarousel(crops) {
    const carousel = document.getElementById('cropsCarousel');

    if (crops.length === 0) {
        carousel.innerHTML = `
            <div class="swiper-slide">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>Aucune culture trouv√©e</h5>
                    <p class="text-muted">Essayez avec d'autres termes de recherche ou filtres.</p>
                </div>
            </div>
        `;

        if (swiper) {
            swiper.destroy();
            swiper = null;
        }
        return;
    }

    // Grouper les cultures par slides
    const slides = [];
    for (let i = 0; i < crops.length; i += CROPS_PER_SLIDE) {
        slides.push(crops.slice(i, i + CROPS_PER_SLIDE));
    }

    const slidesHTML = slides.map(slidecrops => {
        const cardsHTML = slidecrops.map(crop => createCropCard(crop, true)).join('');
        return `
            <div class="swiper-slide">
                <div class="row g-4 justify-content-center">
                    ${cardsHTML}
                </div>
            </div>
        `;
    }).join('');

    carousel.innerHTML = slidesHTML;

    // Initialiser ou r√©initialiser Swiper
    if (swiper) {
        swiper.destroy();
    }

    swiper = new Swiper('.cropsSwiper', {
        slidesPerView: 1,
        spaceBetween: 30,
        loop: slides.length > 1,
        autoplay: {
            delay: 5000,
            disableOnInteraction: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
            dynamicBullets: true,
        },
        keyboard: {
            enabled: true,
        },
    });

    console.log(`[Carousel] ${slides.length} slides cr√©√©s avec ${crops.length} cultures`);
}

/**
 * Cr√©e une carte de culture
 * @param {Object} crop - L'objet culture
 * @param {Boolean} inCarousel - Si true, ajoute la classe col, sinon ne l'ajoute pas
 */
function createCropCard(crop, inCarousel = false) {
    const categoryIcons = {
        'cereales': 'fa-wheat',
        'legumes': 'fa-carrot',
        'fruits': 'fa-apple-alt',
        'legumineuses': 'fa-leaf',
        'tubercules': 'fa-seedling',
        'cultures_rente': 'fa-coins',
        'oleagineux': 'fa-oil-can',
        'epices': 'fa-mortar-pestle'
    };

    const categoryColors = {
        'cereales': 'warning',
        'legumes': 'success',
        'fruits': 'danger',
        'legumineuses': 'success',
        'tubercules': 'primary',
        'cultures_rente': 'info',
        'oleagineux': 'warning',
        'epices': 'secondary'
    };

    const icon = categoryIcons[crop.category] || 'fa-seedling';
    const color = categoryColors[crop.category] || 'success';

    // Generate Unsplash image URL based on crop name
    const getUnsplashImage = (cropName, category) => {
        // Mapping des cultures aux termes de recherche Unsplash
        const imageMap = {
            'Mil': 'millet+grain',
            'Ma√Øs': 'corn+maize+field',
            'Riz': 'rice+paddy',
            'Arachide': 'peanut+groundnut',
            'Sorgho': 'sorghum+grain',
            'Fonio': 'fonio+grain',
            'Ni√©b√©': 'cowpea+beans',
            'Tomate': 'tomato+plant',
            'Oignon': 'onion+farm',
            'Piment': 'pepper+chili',
            'Aubergine': 'eggplant+farm',
            'Gombo': 'okra+plant',
            'Past√®que': 'watermelon+farm',
            'Melon': 'melon+cantaloupe',
            'Banane': 'banana+plantation',
            'Mangue': 'mango+tree',
            'Papaye': 'papaya+tree',
            'Citron': 'lemon+tree',
            'Orange': 'orange+tree',
            'Mandarine': 'mandarin+orange',
            'Patate douce': 'sweet+potato',
            'Manioc': 'cassava+plant',
            'Igname': 'yam+tuber',
        };

        const searchTerm = imageMap[cropName] || cropName.toLowerCase();
        return `https://source.unsplash.com/600x400/?${searchTerm},agriculture`;
    };

    const cropImage = crop.image || getUnsplashImage(crop.name_fr || crop.name, crop.category);

    const cardContent = `
        <div class="card crop-card shadow-sm h-100" data-crop-id="${crop.id}">
            ${crop.drought_resistant ? '<span class="crop-badge badge bg-warning"><i class="fas fa-sun"></i> R√©sistant s√©cheresse</span>' : ''}

            <img src="${cropImage}"
                 class="card-img-top crop-card-image"
                 alt="${crop.name_fr || crop.name}"
                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'crop-card-image d-flex align-items-center justify-content-center\\'><i class=\\'fas ${icon} crop-card-icon\\'></i></div>' + this.parentElement.innerHTML;"
                 loading="lazy">

            <div class="card-body">
                <h5 class="card-title text-success mb-2">
                    <i class="fas ${icon}"></i> ${crop.name_fr || crop.name}
                </h5>
                <p class="card-text small text-muted mb-2">
                    <i>${crop.scientific_name || ''}</i>
                </p>
                ${crop.name_wo ? `<p class="card-text small text-muted mb-2">üó£Ô∏è ${crop.name_wo}</p>` : ''}
                <div class="mb-3">
                    <span class="badge bg-${color}">${crop.category || 'N/A'}</span>
                    ${crop.water_requirement ? `<span class="badge bg-info">${crop.water_requirement}</span>` : ''}
                </div>
                <div class="text-muted small">
                    <i class="fas fa-calendar"></i> ${crop.growing_season || 'N/A'}<br>
                    <i class="fas fa-clock"></i> ${crop.growth_duration_days ? crop.growth_duration_days + ' jours' : 'N/A'}
                </div>
            </div>
            <div class="card-footer bg-transparent border-top-0">
                <div class="d-grid">
                    <button class="btn btn-outline-success btn-sm" onclick="showCropDetails(${crop.id})">
                        <i class="fas fa-info-circle"></i> Voir les d√©tails
                    </button>
                </div>
            </div>
        </div>
    `;

    // Wrap in column div only if in carousel
    if (inCarousel) {
        return `<div class="col-lg-3 col-md-6">${cardContent}</div>`;
    }
    return cardContent;
}

/**
 * Configure la recherche intelligente
 */
function setupSearch() {
    const searchInput = document.getElementById('cropSearch');
    const searchResults = document.getElementById('searchResults');
    const clearBtn = document.getElementById('clearSearch');
    let searchTimeout;

    // √âv√©nement de saisie
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        // Afficher/masquer le bouton clear
        clearBtn.style.display = query ? 'block' : 'none';

        // Debounce pour √©viter trop de recherches
        clearTimeout(searchTimeout);

        if (query.length === 0) {
            searchResults.style.display = 'none';
            filteredCrops = allCrops;
            displayCarousel(allCrops);
            updateCropCount(allCrops.length);
            return;
        }

        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });

    // Bouton clear
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus();
        clearBtn.style.display = 'none';
        searchResults.style.display = 'none';
        filteredCrops = allCrops;
        displayCarousel(allCrops);
        updateCropCount(allCrops.length);
    });

    // Suggestions rapides
    document.querySelectorAll('.search-suggestion').forEach(btn => {
        btn.addEventListener('click', function() {
            const query = this.dataset.query;
            searchInput.value = query;
            performSearch(query);
        });
    });

    // Fermer les r√©sultats si clic ailleurs
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
}

/**
 * Effectue une recherche intelligente
 */
function performSearch(query) {
    const searchResults = document.getElementById('searchResults');
    const normalizedQuery = normalizeString(query);

    // Recherche intelligente avec scoring
    const results = allCrops.map(crop => {
        let score = 0;
        const nameFr = normalizeString(crop.name_fr || crop.name || '');
        const nameWo = normalizeString(crop.name_wo || '');
        const category = normalizeString(crop.category || '');
        const scientific = normalizeString(crop.scientific_name || '');

        // Correspondance exacte du nom (score le plus √©lev√©)
        if (nameFr === normalizedQuery || nameWo === normalizedQuery) {
            score += 100;
        }

        // D√©but du nom
        if (nameFr.startsWith(normalizedQuery) || nameWo.startsWith(normalizedQuery)) {
            score += 50;
        }

        // Contient le terme
        if (nameFr.includes(normalizedQuery)) score += 30;
        if (nameWo.includes(normalizedQuery)) score += 25;
        if (category.includes(normalizedQuery)) score += 20;
        if (scientific.includes(normalizedQuery)) score += 15;

        // Recherche par mots-cl√©s
        const keywords = (crop.keywords || '').toLowerCase().split(',');
        keywords.forEach(keyword => {
            if (normalizeString(keyword).includes(normalizedQuery)) {
                score += 10;
            }
        });

        return { crop, score };
    })
    .filter(item => item.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, 10); // Limiter √† 10 r√©sultats

    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="p-3 text-center text-muted">
                <i class="fas fa-search-minus mb-2"></i><br>
                Aucune culture trouv√©e pour "<strong>${query}</strong>"
            </div>
        `;
        searchResults.style.display = 'block';
        filteredCrops = [];
        displayCarousel([]);
        updateCropCount(0, query);
        return;
    }

    // Afficher les r√©sultats
    const resultsHTML = results.map(({ crop }) => {
        const nameFr = crop.name_fr || crop.name || '';
        const highlightedName = highlightMatch(nameFr, query);

        return `
            <div class="search-result-item" data-crop-id="${crop.id}">
                <div class="d-flex align-items-center">
                    <i class="fas fa-seedling text-success me-3"></i>
                    <div class="flex-grow-1">
                        <strong>${highlightedName}</strong>
                        ${crop.name_wo ? `<span class="text-muted small">- ${crop.name_wo}</span>` : ''}
                        <br>
                        <small class="text-muted">
                            <span class="badge badge-sm bg-light text-dark">${crop.category}</span>
                            ${crop.scientific_name ? `<i class="ms-2">${crop.scientific_name}</i>` : ''}
                        </small>
                    </div>
                    <i class="fas fa-chevron-right text-muted"></i>
                </div>
            </div>
        `;
    }).join('');

    searchResults.innerHTML = resultsHTML;
    searchResults.style.display = 'block';

    // √âv√©nements de clic sur les r√©sultats
    searchResults.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', function() {
            const cropId = parseInt(this.dataset.cropId);
            showCropDetails(cropId);
            searchResults.style.display = 'none';
        });
    });

    // Afficher les cultures filtr√©es dans le carousel
    filteredCrops = results.map(r => r.crop);
    displayCarousel(filteredCrops);
    updateCropCount(filteredCrops.length, query);
}

/**
 * Normalise une cha√Æne pour la recherche
 */
function normalizeString(str) {
    return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
}

/**
 * Met en √©vidence les correspondances dans le texte
 */
function highlightMatch(text, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

/**
 * Configure les filtres par cat√©gorie
 */
function setupFilters() {
    const filterButtons = document.querySelectorAll('.category-filter');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Mettre √† jour les boutons actifs
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            const filter = this.dataset.filter;

            if (filter === 'all') {
                filteredCrops = allCrops;
            } else {
                filteredCrops = allCrops.filter(crop => crop.category === filter);
            }

            displayCarousel(filteredCrops);
            updateCropCount(filteredCrops.length, null, filter);

            // R√©initialiser la recherche
            document.getElementById('cropSearch').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            document.getElementById('searchResults').style.display = 'none';
        });
    });
}

/**
 * Met √† jour le compteur de cultures
 */
function updateCropCount(count, searchQuery = null, filter = null) {
    const countElem = document.getElementById('cropCount');
    const infoElem = document.getElementById('filterInfo');

    countElem.textContent = count;

    let info = '';
    if (searchQuery) {
        info = ` pour la recherche "<strong>${searchQuery}</strong>"`;
    } else if (filter && filter !== 'all') {
        info = ` dans la cat√©gorie "<strong>${filter}</strong>"`;
    }

    infoElem.innerHTML = info;
}

/**
 * Affiche les d√©tails d'une culture (modal)
 */
function showCropDetails(cropId) {
    const crop = allCrops.find(c => c.id === cropId);
    if (!crop) {
        console.error('[Carousel] Culture non trouv√©e:', cropId);
        return;
    }

    console.log('[Carousel] Affichage des d√©tails pour:', crop.name_fr || crop.name);

    // TODO: Ouvrir un modal avec les d√©tails de la culture
    alert(`D√©tails de ${crop.name_fr || crop.name}\n\nCette fonctionnalit√© sera bient√¥t disponible !`);
}

/**
 * Affiche un message d'erreur
 */
function showError(title, message) {
    const carousel = document.getElementById('cropsCarousel');
    carousel.innerHTML = `
        <div class="swiper-slide">
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5>${title}</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-success mt-3" onclick="loadCrops()">
                    <i class="fas fa-sync"></i> R√©essayer
                </button>
            </div>
        </div>
    `;
}

console.log('[Carousel] Script de carousel avec recherche intelligente charg√©');
</script>
