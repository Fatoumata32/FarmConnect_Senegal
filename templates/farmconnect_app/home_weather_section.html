{% load static %}
<!-- Section: Météo et Conseils Agricoles -->
<section class="py-5" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="display-5 fw-bold fade-down" style="color: #2d5016;">
                <i class="fas fa-cloud-sun"></i> <span data-translate="weather_title">Prévisions Météo - 3 Jours</span>
            </h2>
            <p class="lead text-muted fade-up" data-translate="weather_subtitle">
                Planifiez vos activités agricoles avec des prévisions précises
            </p>

            <!-- Sélecteur de Région -->
            <div class="mt-3">
                <select id="region-selector" class="form-select w-auto mx-auto" style="max-width: 300px;">
                    <option value="dakar">Dakar</option>
                    <option value="thies">Thiès</option>
                    <option value="saint-louis">Saint-Louis</option>
                    <option value="diourbel">Diourbel</option>
                    <option value="louga">Louga</option>
                    <option value="fatick">Fatick</option>
                    <option value="kaolack">Kaolack</option>
                    <option value="kaffrine">Kaffrine</option>
                    <option value="tambacounda">Tambacounda</option>
                    <option value="kedougou">Kédougou</option>
                    <option value="kolda">Kolda</option>
                    <option value="sedhiou">Sédhiou</option>
                    <option value="ziguinchor">Ziguinchor</option>
                    <option value="matam">Matam</option>
                </select>
            </div>
        </div>

        <!-- Cartes Météo 3 Jours -->
        <div class="row" id="weather-cards">
            <!-- Chargement initial -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-3 text-muted">Chargement des prévisions météo...</p>
            </div>
        </div>

        <!-- Conseils Agricoles Basés sur la Météo -->
        <div class="row mt-5" id="weather-advice" style="display:none;">
            <div class="col-lg-12">
                <div class="card border-0 shadow-sm" style="border-left: 4px solid #4caf50 !important;">
                    <div class="card-body">
                        <h4 class="card-title text-success mb-3">
                            <i class="fas fa-lightbulb"></i> <span data-translate="weather_advice_title">Conseils Agricoles</span>
                        </h4>
                        <div id="advice-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .weather-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .weather-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
        border-color: #2d5016;
    }

    .weather-card.today {
        border: 2px solid #2d5016;
        background: linear-gradient(135deg, #e8f5e9 0%, #fff 100%);
    }

    .weather-icon {
        font-size: 4rem;
        margin: 20px 0;
    }

    .weather-icon .fa-sun { color: #ffc107; text-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
    .weather-icon .fa-cloud-sun { color: #42a5f5; }
    .weather-icon .fa-cloud { color: #90a4ae; }
    .weather-icon .fa-cloud-rain { color: #546e7a; }
    .weather-icon .fa-cloud-showers-heavy { color: #37474f; }

    .temp-display {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2d5016;
    }

    .temp-range {
        font-size: 1.2rem;
        color: #666;
    }

    .weather-detail {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .weather-detail:last-child {
        border-bottom: none;
    }

    .weather-detail i {
        width: 20px;
        color: #2d5016;
    }

    .advice-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .advice-item.success { background: #e8f5e9; border-left: 4px solid #4caf50; }
    .advice-item.warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    .advice-item.info { background: #e8f5e9; border-left: 4px solid #4a7c59; }

    .advice-item i {
        font-size: 1.5rem;
    }
</style>

<script>
/**
 * Gestion de la météo et des conseils agricoles
 */
document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();

    // Écouter le changement de région
    document.getElementById('region-selector').addEventListener('change', function() {
        loadWeatherData(this.value);
    });
});

/**
 * Charge les données météo depuis l'API
 */
async function loadWeatherData(region = 'dakar') {
    const container = document.getElementById('weather-cards');
    const adviceSection = document.getElementById('weather-advice');
    const adviceContent = document.getElementById('advice-content');

    try {
        // Afficher le spinner
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-3 text-muted">Chargement des prévisions pour ${region}...</p>
            </div>
        `;

        // Charger les prévisions 3 jours
        const response = await fetch(`/api/weather/?region=${region}`);

        if (!response.ok) {
            throw new Error('Erreur de chargement météo');
        }

        const data = await response.json();

        // Afficher les cartes météo
        displayWeatherCards(data);

        // Afficher les conseils agricoles
        if (data.advice) {
            displayAgriculturalAdvice(data.advice);
            adviceSection.style.display = 'block';
        }

        console.log('[Weather] Données chargées pour', region);

    } catch (error) {
        console.error('[Weather] Erreur:', error);
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5>Erreur de chargement</h5>
                <p class="text-muted">Impossible de charger les prévisions météo.</p>
                <button class="btn btn-success mt-3" onclick="loadWeatherData('${region}')">
                    <i class="fas fa-sync"></i> Réessayer
                </button>
            </div>
        `;
    }
}

/**
 * Affiche les cartes météo pour 3 jours
 */
function displayWeatherCards(data) {
    const container = document.getElementById('weather-cards');
    const forecast = data.forecast || [];

    if (forecast.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-cloud-sun fa-3x text-muted mb-3"></i>
                <p>Aucune prévision disponible</p>
            </div>
        `;
        return;
    }

    const weatherIcons = {
        'Ensoleillé': 'fa-sun',
        'Partiellement nuageux': 'fa-cloud-sun',
        'Nuageux': 'fa-cloud',
        'Pluie légère': 'fa-cloud-rain',
        'Pluie': 'fa-cloud-showers-heavy',
        'Orage': 'fa-bolt'
    };

    const cards = forecast.slice(0, 3).map((day, index) => {
        const isToday = index === 0;
        const icon = weatherIcons[day.description] || 'fa-cloud-sun';

        return `
            <div class="col-lg-4 mb-4">
                <div class="card weather-card shadow-sm ${isToday ? 'today' : ''}">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-3">
                            ${isToday ? '<strong>Aujourd\'hui</strong>' : day.date_formatted || day.date}
                        </h5>

                        <div class="weather-icon">
                            <i class="fas ${icon}"></i>
                        </div>

                        <div class="temp-display mb-2">
                            ${day.temp_max}°C
                        </div>
                        <div class="temp-range mb-3">
                            <i class="fas fa-arrow-down"></i> ${day.temp_min}°C
                        </div>

                        <p class="text-muted mb-4">${day.description}</p>

                        <div class="text-start">
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span>Humidité: ${day.humidity}%</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span>Vent: ${day.wind_speed} km/h</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-umbrella"></i>
                                <span>Pluie: ${Math.round(day.rain_chance)}%</span>
                            </div>
                            ${day.rain_total > 0 ? `
                                <div class="weather-detail">
                                    <i class="fas fa-cloud-rain"></i>
                                    <span>Précipitations: ${day.rain_total}mm</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = cards;
}

/**
 * Affiche les conseils agricoles
 */
function displayAgriculturalAdvice(advice) {
    const container = document.getElementById('advice-content');

    let html = '';

    // Conseils d'aujourd'hui
    if (advice.today && advice.today.length > 0) {
        html += '<h6 class="mb-3"><i class="fas fa-calendar-day"></i> Aujourd\'hui</h6>';
        advice.today.forEach(item => {
            html += `
                <div class="advice-item ${item.type}">
                    <i class="fas ${item.icon}"></i>
                    <span>${item.text}</span>
                </div>
            `;
        });
    }

    // Conseils pour la semaine
    if (advice.week && advice.week.length > 0) {
        html += '<h6 class="mb-3 mt-4"><i class="fas fa-calendar-week"></i> Cette Semaine</h6>';
        advice.week.forEach(item => {
            html += `
                <div class="advice-item ${item.type}">
                    <i class="fas ${item.icon}"></i>
                    <span>${item.text}</span>
                </div>
            `;
        });
    }

    // Alertes
    if (advice.alerts && advice.alerts.length > 0) {
        html += '<div class="alert alert-info mt-4" role="alert">';
        html += '<h6 class="alert-heading"><i class="fas fa-info-circle"></i> Bulletin Agricole</h6>';
        advice.alerts.forEach(alert => {
            html += `<p class="mb-0"><strong>${alert.title}:</strong> ${alert.text}</p>`;
        });
        html += '</div>';
    }

    container.innerHTML = html;
}
</script>
